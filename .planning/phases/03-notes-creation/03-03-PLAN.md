---
phase: 03-notes-creation
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/notes.rs
autonomous: true

must_haves:
  truths:
    - "User can apply bold formatting to selected text"
    - "User can apply italic formatting to selected text"
    - "User can apply underline formatting to selected text"
    - "User can apply strikethrough formatting to selected text"
    - "User can create bullet lists"
    - "User can create numbered lists"
    - "User can create checklists with clickable checkboxes"
  artifacts:
    - path: "src/notes.rs"
      provides: "Rich text formatting toolbar and checklist support"
      contains: "execCommand"
  key_links:
    - from: "src/notes.rs"
      to: "document.execCommand"
      via: "wasm_bindgen extern"
      pattern: "execCommand\\(\"bold\""
---

<objective>
Implement rich text formatting toolbar with bold, italic, underline, strikethrough, bullet lists, numbered lists, and clickable checklists.

Purpose: Enable users to format their notes with common text styles and create actionable checklists.

Output: Fully functional formatting toolbar in NoteEditor component with all formatting operations working.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-notes-creation/03-RESEARCH.md
@.planning/phases/03-notes-creation/03-01-SUMMARY.md

@src/notes.rs (update NoteEditor component)
@src/textedit.rs (reference for execCommand pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add execCommand extern and formatting functions</name>
  <files>src/notes.rs</files>
  <action>
Add the wasm_bindgen extern for execCommand at the top of notes.rs (after other imports, before data structures):

```rust
#[wasm_bindgen]
extern "C" {
    #[wasm_bindgen(js_namespace = document)]
    fn execCommand(command: &str, show_ui: bool, value: &str) -> bool;
}
```

This follows the same pattern as textedit.rs and enables rich text formatting via browser APIs.
  </action>
  <verify>
Run `cargo check` - should compile with no errors.
  </verify>
  <done>
execCommand extern declared in notes.rs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement formatting toolbar in NoteEditor</name>
  <files>src/notes.rs</files>
  <action>
Replace the NoteEditor component with this enhanced version that includes the full formatting toolbar:

```rust
#[component]
fn NoteEditor(
    state: ReadSignal<NotesState>,
    set_state: WriteSignal<NotesState>,
) -> impl IntoView {
    let editor_ref: NodeRef<html::Div> = NodeRef::new();

    let selected_note = Memo::new(move |_| {
        let st = state.get();
        st.selected_note_id.as_ref().and_then(|id| {
            st.notes.iter().find(|n| &n.id == id).cloned()
        })
    });

    // Load content into editor when selected note changes
    Effect::new(move |_| {
        if let Some(note) = selected_note.get() {
            if let Some(el) = editor_ref.get() {
                el.set_inner_html(&note.content);
            }
        } else {
            if let Some(el) = editor_ref.get() {
                el.set_inner_html("");
            }
        }
    });

    // Save content helper
    let save_content = move || {
        if let Some(el) = editor_ref.get() {
            let content = el.inner_html();
            set_state.update(|s| {
                if let Some(note_id) = &s.selected_note_id {
                    if let Some(note) = s.notes.iter_mut().find(|n| &n.id == note_id) {
                        note.content = content.clone();
                        note.updated_at = js_sys::Date::now();
                        // Update title from first line
                        let title = extract_title(&content);
                        note.title = title;
                    }
                }
            });
        }
    };

    // Save content on blur
    let on_blur = move |_| {
        save_content();
    };

    // Formatting handlers - refocus editor after each operation
    let format_bold = move |_: leptos::ev::MouseEvent| {
        execCommand("bold", false, "");
        if let Some(el) = editor_ref.get() {
            let _ = el.focus();
        }
    };

    let format_italic = move |_: leptos::ev::MouseEvent| {
        execCommand("italic", false, "");
        if let Some(el) = editor_ref.get() {
            let _ = el.focus();
        }
    };

    let format_underline = move |_: leptos::ev::MouseEvent| {
        execCommand("underline", false, "");
        if let Some(el) = editor_ref.get() {
            let _ = el.focus();
        }
    };

    let format_strikethrough = move |_: leptos::ev::MouseEvent| {
        execCommand("strikeThrough", false, "");
        if let Some(el) = editor_ref.get() {
            let _ = el.focus();
        }
    };

    let insert_bullet_list = move |_: leptos::ev::MouseEvent| {
        execCommand("insertUnorderedList", false, "");
        if let Some(el) = editor_ref.get() {
            let _ = el.focus();
        }
    };

    let insert_numbered_list = move |_: leptos::ev::MouseEvent| {
        execCommand("insertOrderedList", false, "");
        if let Some(el) = editor_ref.get() {
            let _ = el.focus();
        }
    };

    // Insert checklist item using insertHTML
    let insert_checklist = move |_: leptos::ev::MouseEvent| {
        let checkbox_html = r#"<div class="note-checklist-item"><input type="checkbox" class="note-checkbox" /><span>&nbsp;</span></div>"#;
        execCommand("insertHTML", false, checkbox_html);
        if let Some(el) = editor_ref.get() {
            let _ = el.focus();
        }
    };

    view! {
        <div class="notes-editor">
            <div class="notes-editor-toolbar">
                <div class="notes-toolbar-group">
                    <button
                        class="notes-toolbar-btn"
                        on:click=format_bold
                        title="Bold (Cmd+B)"
                    >
                        <strong>"B"</strong>
                    </button>
                    <button
                        class="notes-toolbar-btn"
                        on:click=format_italic
                        title="Italic (Cmd+I)"
                    >
                        <em>"I"</em>
                    </button>
                    <button
                        class="notes-toolbar-btn"
                        on:click=format_underline
                        title="Underline (Cmd+U)"
                    >
                        <u>"U"</u>
                    </button>
                    <button
                        class="notes-toolbar-btn"
                        on:click=format_strikethrough
                        title="Strikethrough"
                    >
                        <s>"S"</s>
                    </button>
                </div>

                <div class="notes-toolbar-separator"></div>

                <div class="notes-toolbar-group">
                    <button
                        class="notes-toolbar-btn"
                        on:click=insert_bullet_list
                        title="Bullet List"
                    >
                        "•"
                    </button>
                    <button
                        class="notes-toolbar-btn"
                        on:click=insert_numbered_list
                        title="Numbered List"
                    >
                        "1."
                    </button>
                    <button
                        class="notes-toolbar-btn"
                        on:click=insert_checklist
                        title="Checklist"
                    >
                        "☑"
                    </button>
                </div>
            </div>

            <Show
                when=move || selected_note.get().is_some()
                fallback=|| view! {
                    <div class="notes-editor-empty">
                        <div class="notes-editor-empty-text">"Select a note or create a new one"</div>
                    </div>
                }
            >
                <div
                    class="notes-editor-content"
                    contenteditable="true"
                    node_ref=editor_ref
                    on:blur=on_blur
                />
            </Show>
        </div>
    }
}

// Helper function to extract title from HTML content
fn extract_title(content: &str) -> String {
    content
        .split("<br>")
        .next()
        .or_else(|| content.split("<div>").next())
        .map(|s| {
            // Strip HTML tags
            let mut result = String::new();
            let mut in_tag = false;
            for c in s.chars() {
                if c == '<' { in_tag = true; }
                else if c == '>' { in_tag = false; }
                else if !in_tag { result.push(c); }
            }
            result.trim().to_string()
        })
        .filter(|s| !s.is_empty())
        .unwrap_or_else(|| "New Note".to_string())
}
```

Key changes:
1. Added formatting button handlers using execCommand
2. Each handler refocuses the editor after formatting to maintain cursor position
3. Checklist uses insertHTML to insert a checkbox div structure
4. Extracted title extraction logic to a helper function
5. Removed placeholder toolbar text, added real buttons
6. Added title attributes for tooltip hints
  </action>
  <verify>
Run `cargo check` - should compile with no errors.
Run `trunk serve`, create a note, select text, and test:
- Bold button makes text bold
- Italic button makes text italic
- Underline button underlines text
- Strikethrough button strikes through text
- Bullet list button creates unordered list
- Numbered list button creates ordered list
- Checklist button inserts checkbox item
  </verify>
  <done>
NoteEditor has full formatting toolbar with:
- Bold, italic, underline, strikethrough buttons
- Bullet list and numbered list buttons
- Checklist insertion button
- All formatting operations work via execCommand
  </done>
</task>

<task type="auto">
  <name>Task 3: Add checkbox click handler for checklists</name>
  <files>src/notes.rs</files>
  <action>
Add an Effect in NoteEditor to set up a click handler for checkboxes within the editor content. This enables the clickable checkbox functionality.

Add this Effect inside the NoteEditor component, after the existing Effects:

```rust
// Set up click handler for checkboxes in editor
Effect::new(move |_| {
    // Re-run when selected note changes to attach handlers to new content
    let _ = selected_note.get();

    #[cfg(target_arch = "wasm32")]
    {
        if let Some(el) = editor_ref.get() {
            use wasm_bindgen::JsCast;

            // Use event delegation on the editor element for checkbox clicks
            let el_clone = el.clone();
            let set_state_clone = set_state;

            let handler = wasm_bindgen::closure::Closure::wrap(Box::new(move |e: web_sys::Event| {
                if let Some(target) = e.target() {
                    if let Ok(input) = target.dyn_into::<web_sys::HtmlInputElement>() {
                        if input.class_list().contains("note-checkbox") {
                            // Checkbox was clicked, save the state
                            let content = el_clone.inner_html();
                            set_state_clone.update(|s| {
                                if let Some(note_id) = &s.selected_note_id {
                                    if let Some(note) = s.notes.iter_mut().find(|n| &n.id == note_id) {
                                        note.content = content.clone();
                                        note.updated_at = js_sys::Date::now();
                                    }
                                }
                            });
                        }
                    }
                }
            }) as Box<dyn Fn(web_sys::Event)>);

            let _ = el.add_event_listener_with_callback("click", handler.as_ref().unchecked_ref());
            handler.forget(); // Keep the closure alive
        }
    }
});
```

Also add the necessary imports at the top of the file if not already present:
```rust
use wasm_bindgen::JsCast;
```

This enables checkboxes within notes to be toggled, and automatically saves the checked state to the note content.
  </action>
  <verify>
Run `cargo check` - should compile with no errors.
Run `trunk serve`:
1. Create a note
2. Click checklist button to insert a checkbox
3. Click the checkbox - it should toggle checked state
4. Blur/unfocus the editor
5. Refresh page - checkbox state should persist
  </verify>
  <done>
Checkboxes in notes are clickable and their state persists.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cargo check` passes
2. `trunk serve` serves the app
3. Create a new note (will be enabled in Plan 04, but can test with pre-existing note)
4. Select text and apply bold - text becomes bold
5. Select text and apply italic - text becomes italic
6. Select text and apply underline - text becomes underlined
7. Select text and apply strikethrough - text has strikethrough
8. Click bullet list - creates unordered list
9. Click numbered list - creates ordered list
10. Click checklist - inserts checkbox
11. Click checkbox - toggles checked state
12. Refresh - all formatting persists
</verification>

<success_criteria>
- All 7 formatting operations work (bold, italic, underline, strikethrough, bullets, numbers, checklist)
- Checkboxes are clickable and toggle visually
- Formatting persists in localStorage after refresh
- Toolbar buttons have hover states and proper styling
</success_criteria>

<output>
After completion, create `.planning/phases/03-notes-creation/03-03-SUMMARY.md`
</output>
