---
phase: 02-terminal-textedit-persistence
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/textedit.rs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "New text typed after restore uses the restored font family setting"
    - "New text typed after restore uses the restored font size setting"
    - "New text typed after restore respects the restored alignment setting"
  artifacts:
    - path: "src/textedit.rs"
      provides: "Effect to apply toolbar settings to editing context on mount"
      contains: "execCommand.*fontName"
  key_links:
    - from: "src/textedit.rs content restoration Effect"
      to: "editor context initialization"
      via: "second Effect calls execCommand for font, size, alignment"
      pattern: "execCommand.*fontName.*fontSize.*justify"
---

<objective>
Apply TextEdit toolbar settings (font family, font size, alignment) to the editing context after content restoration, so new text inherits the restored settings.

Purpose: Fix the gap where toolbar buttons showed restored settings but new text didn't use them. The content restoration Effect restores HTML but doesn't initialize the document's editing context for new input.

Output: TextEdit toolbar settings are applied to the editor via execCommand on mount, ensuring new text uses the restored font family, size, and alignment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-terminal-textedit-persistence/02-02-SUMMARY.md
@src/textedit.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Effect to apply toolbar settings to editor context on mount</name>
  <files>src/textedit.rs</files>
  <action>
After the content restoration Effect (lines 101-113), add a second Effect to apply the toolbar settings (font family, font size, alignment) to the editor's editing context.

Add this Effect immediately after the content restoration Effect:

```rust
    // Apply toolbar settings to editor context after content restoration
    Effect::new({
        move |_| {
            if content_restored.get_value() {
                // Only apply settings after content is restored
                let family = font_family.get_untracked();
                let size = font_size.get_untracked();
                let align = alignment.get_untracked();

                // Apply font family to editor context
                execCommand("fontName", false, &family);

                // Apply font size to editor context (size in pixels)
                execCommand("fontSize", false, &size.to_string());

                // Apply alignment to editor context
                let align_cmd = match align.as_str() {
                    "center" => "justifyCenter",
                    "right" => "justifyRight",
                    "justify" => "justifyFull",
                    _ => "justifyLeft",
                };
                execCommand(align_cmd, false, "");
            }
        }
    });
```

This Effect:
- Runs after content_restored becomes true
- Calls execCommand for fontName, fontSize, and alignment
- Ensures new text typed will inherit the restored settings
- Uses get_untracked() to read initial state without creating dependencies

IMPORTANT:
- Place this Effect AFTER the content restoration Effect (after line 113)
- Do NOT move or modify the content restoration Effect
- The Effect runs on mount but only applies settings after content_restored is true
  </action>
  <verify>
Run `cargo build --all-targets --all-features` - should compile without errors.
Run `cargo clippy --all-targets --all-features -- -D warnings` - should pass.
Run `cargo fmt --all` - should format code correctly.
  </verify>
  <done>
New Effect added after content restoration Effect. Effect calls execCommand for fontName, fontSize, and alignment based on restored toolbar settings. No compilation errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Added Effect to apply toolbar settings (font family, font size, alignment) to the editor context after content restoration on mount.
  </what-built>
  <how-to-verify>
1. Run `trunk serve` and open the app in browser
2. Open TextEdit app
3. Type some text: "Hello World"
4. Change font family to "Monaco"
5. Change font size to "24"
6. Click center align button
7. Refresh the page (F5 or Cmd+R)
8. Open TextEdit again
9. Verify toolbar buttons show the restored settings (Monaco, 24, center align)
10. **CRITICAL TEST:** Click in the document and type new text: "New text"
11. Verify the new text is in Monaco font, 24px size, and centered
12. Compare with old text "Hello World" - it should have the same formatting

Expected result: New text automatically uses the restored settings without any additional button clicks.

If the new text does NOT use the restored formatting, the gap is not closed.
  </how-to-verify>
  <resume-signal>Type "approved" if new text uses the restored settings after refresh, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
Gap closure verification:

1. **New text uses restored font family:**
   - Restore Monaco font, type new text, verify it displays in Monaco

2. **New text uses restored font size:**
   - Restore 24px font size, type new text, verify it displays at 24px

3. **New text uses restored alignment:**
   - Restore center alignment, type new text, verify it's centered (not left-aligned)

4. **Toolbar settings match new text:**
   - All toolbar buttons reflect the restored settings
   - New text actually uses those settings

5. **Code quality:**
   - `cargo fmt --all`
   - `cargo clippy --all-targets --all-features -- -D warnings`
   - `cargo build --all-targets --all-features`
   - `cargo test --all-features`
</verification>

<success_criteria>
- New text typed after restore uses the restored font family
- New text typed after restore uses the restored font size
- New text typed after restore respects the restored alignment
- Toolbar buttons show restored settings (already working)
- All Rust pre-commit checks pass
- No console errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-terminal-textedit-persistence/02-03-SUMMARY.md`
</output>
