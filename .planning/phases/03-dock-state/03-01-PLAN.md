---
phase: 03-dock-state
plan: 01
type: execute
wave: 1
depends_on:
  - phase: 01-calculator-persistence
  - phase: 02-terminal-textedit-persistence
files_modified:
  - src/dock.rs
  - src/system_state.rs
  - src/window_manager.rs
autonomous: true

must_haves:
  truths:
    - "Dock pinned apps persist across page refresh"
    - "Dock order persists across page refresh"
    - "Running indicators reflect open windows (derived, not stored)"
    - "Default pinned set is reasonable and restored when storage missing"
    - "State stored under virtualmac_dock localStorage key"
    - "Dock gracefully handles missing or corrupted storage"
  artifacts:
    - path: "src/dock.rs"
      provides: "DockState persistence + derived running indicators"
      contains: "DockState"
      min_lines: 200
  key_links:
    - from: "src/dock.rs"
      to: "localStorage"
      via: "save_to_storage"
      pattern: "storage\\.set_item.*virtualmac_dock"
    - from: "src/dock.rs"
      to: "localStorage"
      via: "load_from_storage"
      pattern: "storage\\.get_item.*virtualmac_dock"
---

<objective>
Persist dock state (pinned apps + order) and ensure running indicators derive from open windows.

Purpose: Preserve the user's dock layout across refresh while keeping running indicators accurate and derived from active windows. Default pinned apps should be restored when storage is missing, and the dock should remain stable across sessions.

Output: Dock uses persisted pinned app list/order, running indicators reflect open windows, and state is stored under `virtualmac_dock`.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dock-state/03-CONTEXT.md
@src/dock.rs
@src/system_state.rs
@src/window_manager.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Establish dock persistence model</name>
  <files>src/dock.rs</files>
  <action>
Define a DockState persistence model using the existing persistence pattern (Calculator/Terminal):

1. Add serde imports:
   ```rust
   use serde::{Deserialize, Serialize};
   ```

2. Add constants and state struct:
   ```rust
   const STORAGE_KEY: &str = "virtualmac_dock";
   const CURRENT_SCHEMA_VERSION: u32 = 1;

   #[derive(Clone, Debug, Serialize, Deserialize)]
   struct DockState {
       schema_version: u32,
       pinned_apps: Vec<String>,
   }

   impl DockState {
       fn default_with_pins() -> Self {
           Self {
               schema_version: CURRENT_SCHEMA_VERSION,
               pinned_apps: default_pinned_apps(),
           }
       }
   }
   ```

3. Add default pinned list helper (reasonable, core apps only):
   ```rust
   fn default_pinned_apps() -> Vec<String> {
       vec![
           "Finder".to_string(),
           "Safari".to_string(),
           "Messages".to_string(),
           "Mail".to_string(),
           "Photos".to_string(),
           "Music".to_string(),
           "Notes".to_string(),
           "Calendar".to_string(),
           "TextEdit".to_string(),
           "Calculator".to_string(),
           "System Settings".to_string(),
           "Terminal".to_string(),
       ]
   }
   ```

4. Add save/load helpers (platform-gated, graceful fallback):
   ```rust
   fn save_to_storage(state: &DockState) { ... }
   fn load_from_storage() -> DockState { ... }
   ```

5. Initialize a dock_state signal in Dock with load_from_storage and ensure fallback to defaults if storage is missing or invalid.

IMPORTANT:
- Do NOT persist running indicators; they are derived state.
- Keep the full app catalog available so pinned apps can be re-added later by another mechanism.
  </action>
  <verify>
  `cargo build --all-targets --all-features`
  </verify>
  <done>
  DockState exists with schema_version and pinned_apps, save/load helpers added, dock_state signal initialized from storage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Derive running indicators from open windows</name>
  <files>src/dock.rs, src/system_state.rs, src/window_manager.rs</files>
  <action>
Replace hard-coded is_running values with derived logic based on open windows:

1. Identify the authoritative source for open windows in SystemState/WindowManager.
2. Create a helper in dock.rs that returns a set of running app names derived from open windows.
3. When building DockItem values, set is_running by checking if the app name exists in the running set.

Constraints:
- Running indicators must reflect open windows only.
- Do not change indicator visuals or sizing in this phase.
  </action>
  <verify>
  Running indicators toggle when windows open/close for an app.
  </verify>
  <done>
  Running indicators are derived from open windows, not stored values.
  </done>
</task>

<task type="auto">
  <name>Task 3: Render dock from persisted pinned list</name>
  <files>src/dock.rs</files>
  <action>
Use pinned_apps from DockState to render the dock in persisted order:

1. Define a catalog mapping app name -> icon + icon_class + open handler.
2. Build DockItem list by iterating pinned_apps in order, using the catalog.
3. If a pinned app is missing from the catalog, skip it gracefully.
4. Ensure the default pinned list is used when storage is empty or corrupted.

Note:
- Do not implement the re-add UI here; this is just persistence and rendering.
  </action>
  <verify>
  Dock order matches pinned_apps order on refresh.
  </verify>
  <done>
  Dock renders from persisted pinned list, with stable order across refresh.
  </done>
</task>

<task type="auto">
  <name>Task 4: Manual verification</name>
  <files>src/dock.rs</files>
  <action>
Manual checks (no code changes unless issues found):

1. Load app and confirm default dock order matches the default pinned list.
2. Change pinned order/state (if there is an existing mechanism) and refresh; verify order persists.
3. Open and close app windows; confirm running indicators appear only while windows are open.
4. Clear localStorage key `virtualmac_dock` and refresh; default pinned list restores without errors.

If any issues found, fix and re-run verification.

Final checks:
- `cargo fmt --all`
- `cargo clippy --all-targets --all-features -- -D warnings`
- `cargo build --all-targets --all-features`
- `cargo test --all-features`
  </action>
  <verify>
  Pinned apps persist across refresh, running indicators track open windows, no console errors.
  </verify>
  <done>
  All checks pass, dock persistence works as expected.
  </done>
</task>

</tasks>

<verification>
1. Default dock renders core pinned apps in expected order.
2. Refresh retains pinned list and order.
3. Running indicators reflect open windows only (no false positives).
4. localStorage missing/corrupted falls back to defaults without errors.
5. Rust checks pass: fmt, clippy, build, test.
</verification>

<success_criteria>
- Pinned apps list persists under `virtualmac_dock`
- Dock order persists across refresh
- Running indicators reflect open windows
- Defaults restore when storage missing
- No storage errors in console
- All Rust pre-commit checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-dock-state/03-01-SUMMARY.md`
</output>
