---
phase: 02-terminal-polish
plan: 04
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - src/terminal.rs
autonomous: false

must_haves:
  truths:
    - "User can type 'clear' to clear the terminal"
    - "User can press Cmd+K to clear the terminal"
    - "Terminal auto-scrolls to bottom when new output appears"
  artifacts:
    - path: "src/terminal.rs"
      provides: "Clear command and Cmd+K shortcut"
      contains: "meta_key"
  key_links:
    - from: "src/terminal.rs"
      to: "terminal output element"
      via: "scroll behavior"
      pattern: "scroll_into_view|scrollTop"
---

<objective>
Add clear command, Cmd+K shortcut, and auto-scroll behavior, then verify complete terminal polish.

Purpose: Complete the terminal UX with screen clearing (essential terminal feature) and proper scroll behavior.
Output: Fully polished terminal matching REQ-002 requirements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-terminal-polish/02-RESEARCH.md
@src/terminal.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add clear command and Cmd+K shortcut</name>
  <files>src/terminal.rs</files>
  <action>
    The `clear` command likely already exists (check execute_command match). Ensure it works correctly and add Cmd+K support:

    1. Verify `clear` command in execute_command:
       ```rust
       "clear" => {
           set_history.set(Vec::new());
           return; // Don't add "clear" to output
       }
       ```

    2. Add Cmd+K handling to on_keydown (at the START of the function, before the match):
       ```rust
       let on_keydown = move |e: KeyboardEvent| {
           // Cmd+K clears terminal (macOS standard)
           if e.meta_key() && e.key() == "k" {
               e.prevent_default();
               set_history.set(Vec::new());
               return;
           }

           // ... existing match statement ...
       };
       ```

    Note: `e.meta_key()` returns true when Cmd (Mac) or Windows key is pressed. On Mac keyboards this is the Cmd key.
  </action>
  <verify>
    Run `trunk serve`:
    - Type several commands to fill the terminal
    - Type `clear` and press Enter - terminal output clears
    - Type more commands
    - Press Cmd+K - terminal output clears
  </verify>
  <done>Both 'clear' command and Cmd+K shortcut clear terminal output</done>
</task>

<task type="auto">
  <name>Task 2: Add auto-scroll to bottom on new output</name>
  <files>src/terminal.rs</files>
  <action>
    Add auto-scroll behavior so the terminal always shows the latest output:

    1. Add a NodeRef for the output container (near existing input_ref):
       ```rust
       let output_ref: NodeRef<leptos::html::Div> = NodeRef::new();
       ```

    2. Add the ref to the output div in the view:
       ```rust
       <div class="terminal-output" node_ref=output_ref>
       ```

    3. Add an Effect that scrolls to bottom when history changes:
       ```rust
       Effect::new(move |_| {
           // Subscribe to history changes
           let _ = history.get();
           // Scroll to bottom
           if let Some(el) = output_ref.get() {
               let scroll_height = el.scroll_height();
               el.set_scroll_top(scroll_height);
           }
       });
       ```

    Place the Effect after the signal declarations but before the closures (like execute_command).

    Note: This effect will run on every history update, ensuring new output is always visible.
  </action>
  <verify>
    Run `trunk serve`:
    - Run commands until output exceeds visible area
    - Each new command should auto-scroll to show the latest output
    - Manual scrolling still works (scroll up to see old output)
    - New command still auto-scrolls to bottom
  </verify>
  <done>Terminal automatically scrolls to show newest output; manual scrolling still works</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Terminal polish: VirtualFileSystem integration, visual styling, command history, tab completion, clear/Cmd+K, auto-scroll</what-built>
  <how-to-verify>
    Test the complete terminal experience:

    1. **Visual Check** - Terminal window should have:
       - Dark background (black at 85% opacity)
       - White monospace text
       - Thin semi-transparent scrollbar

    2. **VirtualFileSystem Integration** - Open Finder and Terminal side by side:
       - `ls /Desktop` should show same files as Finder sidebar Desktop
       - `mkdir /Desktop/TerminalTest` - folder appears in Finder
       - `rm /Desktop/TerminalTest` - folder disappears from Finder

    3. **Prompt Format** - Should display:
       - `guest@virtualmac ~ %` at root
       - `guest@virtualmac Documents %` after `cd /Documents`

    4. **Command History**:
       - Execute: `ls`, `pwd`, `cd /Documents`, `ls`
       - Press Up arrow 4 times - cycles through history
       - Press Down arrow - moves forward
       - Down at newest returns to empty input

    5. **Tab Completion**:
       - `ls /App` + Tab = `ls /Applications/`
       - `cat /Desktop/N` + Tab = `cat /Desktop/Notes.txt`

    6. **Clear**:
       - Fill terminal with commands
       - Type `clear` + Enter - terminal clears
       - Type more commands
       - Press Cmd+K - terminal clears

    7. **Auto-scroll**:
       - Generate lots of output (`help` repeatedly)
       - Each command should scroll to bottom
  </how-to-verify>
  <resume-signal>Type "approved" if terminal matches macOS experience, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `trunk build` compiles without errors
2. All REQ-002 acceptance criteria met:
   - REQ-002.1: Terminal window styling (dark background, proper padding)
   - REQ-002.2: Monospace font (SF Mono/Menlo)
   - REQ-002.3: Color scheme (white on black)
   - REQ-002.4: Command prompt (guest@virtualmac format)
   - REQ-002.5: Command history (up/down arrows)
   - REQ-002.6: Clear command and Cmd+K
   - REQ-002.7: Tab completion
   - REQ-002.8: Scrollable output with styled scrollbar
   - REQ-002.9: VirtualFileSystem integration
</verification>

<success_criteria>
- Clear command empties terminal output
- Cmd+K keyboard shortcut clears terminal
- Terminal auto-scrolls to bottom on new output
- All Phase 2 requirements verified by human checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/02-terminal-polish/02-04-SUMMARY.md`
</output>
