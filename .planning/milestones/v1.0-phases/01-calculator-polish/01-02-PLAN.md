---
phase: 01-calculator-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/calculator.rs
autonomous: true

must_haves:
  truths:
    - "User can type digits (0-9) with keyboard and they appear in display"
    - "User can type operators (+, -, *, /) and they work"
    - "User can press Enter or = to calculate"
    - "User can press Escape to clear"
    - "Active operator button is visually highlighted"
    - "AC button shows C when there is a pending operation"
    - "Large numbers show thousands separators"
  artifacts:
    - path: "src/calculator.rs"
      provides: "Calculator with keyboard support, operator state, AC/C toggle, number formatting"
      exports: ["Calculator"]
      min_lines: 200
  key_links:
    - from: "src/calculator.rs"
      to: "web_sys::KeyboardEvent"
      via: "document keydown listener"
      pattern: "add_event_listener.*keydown"
    - from: "src/calculator.rs"
      to: "styles.css .active class"
      via: "class attribute on operator buttons"
      pattern: "operator.*active"
---

<objective>
Add keyboard support, active operator highlighting, AC/C toggle, and number formatting to Calculator.

Purpose: Complete the Calculator interaction model to match macOS Calculator behavior - users can use keyboard shortcuts, see which operator is active, and see properly formatted numbers with thousands separators.

Output: Updated `src/calculator.rs` with full macOS Calculator behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-calculator-polish/01-RESEARCH.md
@.planning/codebase/CONVENTIONS.md
@src/calculator.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add active operator state tracking and visual highlighting</name>
  <files>src/calculator.rs</files>
  <action>
Add a signal to track which operator is currently active for visual feedback:

1. Add new signal after existing signals:
   ```rust
   let (active_operator, set_active_operator) = signal::<Option<Operation>>(None);
   ```

2. In `append_digit` closure, clear active operator when digit is pressed:
   ```rust
   set_active_operator.set(None);
   ```

3. In `set_operation` closure, set active operator:
   ```rust
   set_active_operator.set(Some(op));
   ```

4. In `do_calculate` closure, clear active operator:
   ```rust
   set_active_operator.set(None);
   ```

5. In `clear` closure, clear active operator:
   ```rust
   set_active_operator.set(None);
   ```

6. Update operator button classes to include "active" when operator is active. Change each operator button from:
   ```rust
   <button class="calc-btn operator" ...>
   ```
   to use a dynamic class:
   ```rust
   <button
       class=move || if active_operator.get() == Some(Operation::Divide) { "calc-btn operator active" } else { "calc-btn operator" }
       ...
   >
   ```
   Do this for all four operator buttons (Divide, Multiply, Subtract, Add). The equals button does NOT get this treatment.
  </action>
  <verify>
`cargo check` passes. Operator buttons have dynamic class attribute.
  </verify>
  <done>
Operator buttons highlight with inverted colors when that operation is pending.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add keyboard support with global event listener</name>
  <files>src/calculator.rs</files>
  <action>
Add global keyboard event handling following the codebase pattern from `window_manager.rs`:

1. Add required imports at top of file:
   ```rust
   use wasm_bindgen::prelude::*;
   use wasm_bindgen::JsCast;
   ```

2. At end of Calculator component (before the `view!` macro), add keyboard event listener using Effect:
   ```rust
   // Clone closures for keyboard handler
   let kb_append_digit = append_digit.clone();
   let kb_set_operation = set_operation.clone();
   let kb_do_calculate = do_calculate.clone();
   let kb_clear = clear.clone();
   let kb_negate = negate.clone();
   let kb_percent = percent.clone();

   Effect::new(move |_| {
       #[cfg(target_arch = "wasm32")]
       {
           let closure = Closure::wrap(Box::new(move |evt: web_sys::KeyboardEvent| {
               match evt.key().as_str() {
                   "0" => kb_append_digit("0"),
                   "1" => kb_append_digit("1"),
                   "2" => kb_append_digit("2"),
                   "3" => kb_append_digit("3"),
                   "4" => kb_append_digit("4"),
                   "5" => kb_append_digit("5"),
                   "6" => kb_append_digit("6"),
                   "7" => kb_append_digit("7"),
                   "8" => kb_append_digit("8"),
                   "9" => kb_append_digit("9"),
                   "." => kb_append_digit("."),
                   "+" => kb_set_operation(Operation::Add),
                   "-" => kb_set_operation(Operation::Subtract),
                   "*" => kb_set_operation(Operation::Multiply),
                   "/" => {
                       evt.prevent_default(); // Prevent browser quick-find
                       kb_set_operation(Operation::Divide);
                   }
                   "=" | "Enter" => kb_do_calculate(),
                   "Escape" | "c" | "C" => kb_clear(),
                   "%" => kb_percent(),
                   _ => {}
               }
           }) as Box<dyn FnMut(_)>);

           if let Some(window) = web_sys::window() {
               if let Some(document) = window.document() {
                   let _ = document.add_event_listener_with_callback(
                       "keydown",
                       closure.as_ref().unchecked_ref(),
                   );
               }
           }
           closure.forget();
       }
   });
   ```

Note: The closures need to be `Fn` not `FnMut`. Since the existing closures use `move |...|` they are already suitable if they only capture `Copy` types (signals are Copy). If there are borrowing issues, the simplest fix is to call the signal setters directly in the match arms rather than through closures.

Alternative simpler approach if closure cloning is problematic - just inline the logic:
   ```rust
   Effect::new(move |_| {
       #[cfg(target_arch = "wasm32")]
       {
           let closure = Closure::wrap(Box::new(move |evt: web_sys::KeyboardEvent| {
               match evt.key().as_str() {
                   "0" | "1" | "2" | "3" | "4" | "5" | "6" | "7" | "8" | "9" | "." => {
                       let digit = evt.key();
                       // Inline append_digit logic
                       if clear_on_next.get() {
                           set_display.set(digit.clone());
                           set_clear_on_next.set(false);
                       } else {
                           let current = display.get();
                           if current == "0" && digit != "." {
                               set_display.set(digit);
                           } else if digit == "." && current.contains('.') {
                               // Don't add another decimal point
                           } else {
                               set_display.set(format!("{}{}", current, digit));
                           }
                       }
                       set_active_operator.set(None);
                   }
                   // ... operators and other keys
               }
           }) as Box<dyn FnMut(_)>);
           // ... rest of setup
       }
   });
   ```
  </action>
  <verify>
`cargo check` passes. No compilation errors with WASM feature flags.
  </verify>
  <done>
Calculator responds to keyboard input: digits, operators, Enter/=, Escape.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add AC/C toggle and number formatting with thousands separators</name>
  <files>src/calculator.rs</files>
  <action>
1. **AC/C Toggle:** Update the clear button to show "C" when there's a pending operation or entered value:
   - Change the AC button from static text to dynamic:
     ```rust
     <button class="calc-btn function" on:click=move |_| clear()>
         {move || if current_op.get() != Operation::None || stored_value.get() != 0.0 { "C" } else { "AC" }}
     </button>
     ```

2. **Number Formatting:** Update `format_result` function to add thousands separators for integers:
   ```rust
   fn format_result(val: f64) -> String {
       if val.is_nan() {
           return String::from("Error");
       }
       if val.is_infinite() {
           return String::from("Error");
       }

       // Check if it's effectively an integer
       if val.fract() == 0.0 && val.abs() < 1e15 {
           // Format integer with thousands separators
           format_with_separators(val as i64)
       } else {
           // Decimal number - limit precision and remove trailing zeros
           let s = format!("{:.9}", val);
           s.trim_end_matches('0').trim_end_matches('.').to_string()
       }
   }

   fn format_with_separators(n: i64) -> String {
       let negative = n < 0;
       let s = n.abs().to_string();
       let chars: Vec<char> = s.chars().rev().collect();
       let formatted: String = chars
           .chunks(3)
           .map(|chunk| chunk.iter().collect::<String>())
           .collect::<Vec<String>>()
           .join(",")
           .chars()
           .rev()
           .collect();
       if negative { format!("-{}", formatted) } else { formatted }
   }
   ```

3. **Backspace support** (optional, if keyboard task doesn't include it): Add "Backspace" | "Delete" case in keyboard handler:
   ```rust
   "Backspace" | "Delete" => {
       let current = display.get();
       if current.len() > 1 {
           set_display.set(current[..current.len()-1].to_string());
       } else {
           set_display.set(String::from("0"));
       }
   }
   ```
  </action>
  <verify>
`cargo check` passes. Enter `1000000` via clicks - should display as `1,000,000`.
  </verify>
  <done>
- AC button toggles to C when operation is pending
- Numbers display with thousands separators (e.g., 1,000,000)
- Backspace deletes last digit
  </done>
</task>

</tasks>

<verification>
- [ ] `cargo check` passes
- [ ] `cargo build --target wasm32-unknown-unknown` succeeds
- [ ] Typing "123456" on keyboard shows "123,456" (after pressing =)
- [ ] Pressing "+" highlights the + button with inverted colors
- [ ] Pressing another digit clears the highlight
- [ ] AC shows "C" after entering an operator
- [ ] Pressing Escape clears and shows "AC" again
</verification>

<success_criteria>
Calculator has full macOS Calculator behavior:
- Keyboard input works (0-9, +, -, *, /, =, Enter, Escape, Backspace)
- Active operator is visually highlighted
- AC/C button toggles based on state
- Numbers display with thousands separators
</success_criteria>

<output>
After completion, create `.planning/phases/01-calculator-polish/01-02-SUMMARY.md`
</output>
