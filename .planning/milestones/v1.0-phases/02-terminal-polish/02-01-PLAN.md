---
phase: 02-terminal-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/terminal.rs
autonomous: true

must_haves:
  truths:
    - "Terminal ls shows same files as Finder"
    - "Terminal mkdir creates folder visible in Finder"
    - "Terminal rm removes file visible in Finder"
    - "Terminal cd navigates to directories that exist in VirtualFileSystem"
  artifacts:
    - path: "src/terminal.rs"
      provides: "Terminal component using VirtualFileSystem"
      contains: "use_file_system"
  key_links:
    - from: "src/terminal.rs"
      to: "src/file_system.rs"
      via: "use_file_system() hook"
      pattern: "use_file_system\\(\\)"
---

<objective>
Integrate Terminal with the shared VirtualFileSystem, removing the duplicate FsNode implementation.

Purpose: Ensure Terminal and Finder show the same file system state. Currently Terminal has its own isolated FsNode tree that doesn't sync with Finder's VirtualFileSystem.
Output: Terminal component that uses the shared VirtualFileSystem for all file operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-terminal-polish/02-RESEARCH.md
@src/terminal.rs
@src/file_system.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove FsNode and integrate VirtualFileSystem</name>
  <files>src/terminal.rs</files>
  <action>
    Refactor terminal.rs to use the shared VirtualFileSystem instead of the internal FsNode tree:

    1. Add import at top: `use crate::file_system::{use_file_system, EntryType};`

    2. Remove the FsNode enum definition (lines 5-10)

    3. Remove the create_filesystem() function (lines 164-202)

    4. Remove helper functions that operate on FsNode:
       - get_node_at_path
       - directory_exists
       - list_directory
       - read_file

    5. In the Terminal component:
       - Replace `let (fs, _set_fs) = signal(create_filesystem());` with `let fs = use_file_system();`
       - The cwd signal stays the same

    6. Rewrite command handlers to use VirtualFileSystem methods:
       - `ls`: Use `fs.list_dir(path)` - returns Vec<FileEntry>. Map entries to names, append "/" for directories. Handle empty vs non-existent differently.
       - `cd`: Use `fs.exists(path)` and `fs.get(path)` to check if target is a directory.
       - `cat`: Use `fs.read_file(path)` which returns Option<String>.
       - `mkdir`: Use `fs.create_dir(path)` after checking `!fs.exists(path)`.
       - `rm`: Use `fs.delete(path)` after checking `fs.exists(path)`.
       - `touch`: Use `fs.write_file(path, "", "ðŸ“„")` to create empty file.

    7. Path resolution helper (keep inline in execute_command closure):
       ```rust
       let resolve_path = |target: &str, cwd: &str| -> String {
           if target.starts_with('/') {
               target.to_string()
           } else if target == "~" {
               "/Users/guest".to_string()
           } else if target == ".." {
               let parts: Vec<&str> = cwd.split('/').collect();
               if parts.len() > 2 {
                   parts[..parts.len()-1].join("/")
               } else {
                   "/".to_string()
               }
           } else {
               format!("{}/{}", cwd, target)
           }
       };
       ```

    8. Keep the get_display_path and get_current_date functions (they don't use FsNode).

    Note: VirtualFileSystem uses different paths than the old FsNode. Old paths like "/Users/guest/Documents" map to VirtualFileSystem's "/Documents". Update the default cwd from "/Users/guest" to "/" or "/Desktop" to match VirtualFileSystem structure.
  </action>
  <verify>
    Run `trunk serve` and in Terminal:
    - `ls /` shows Applications, Desktop, Documents, Downloads
    - `cd /Documents && ls` shows same files as Finder sidebar Documents
    - `mkdir /Desktop/TestFolder` then check Finder - folder appears
    - `rm /Desktop/TestFolder` then check Finder - folder disappears
  </verify>
  <done>Terminal file operations reflect in Finder; Finder changes reflect in Terminal</done>
</task>

<task type="auto">
  <name>Task 2: Update prompt format and default working directory</name>
  <files>src/terminal.rs</files>
  <action>
    Update the shell prompt to match macOS Terminal's zsh format and adjust for VirtualFileSystem paths:

    1. Change default cwd from "/Users/guest" to "/" (since VirtualFileSystem doesn't have /Users/guest):
       `let (cwd, set_cwd) = signal(String::from("/"));`

    2. Update the prompt closure to show just the directory name (macOS style):
       ```rust
       let prompt = move || {
           let path = cwd.get();
           let display = if path == "/" {
               "~".to_string()
           } else {
               path.rsplit('/').next().unwrap_or(&path).to_string()
           };
           format!("guest@virtualmac {} % ", display)
       };
       ```

    3. Update `cd` without args to go to "/" (home equivalent):
       ```rust
       if args.is_empty() {
           set_cwd.set(String::from("/"));
           return;
       }
       ```

    4. Update get_display_path to handle new structure:
       ```rust
       fn get_display_path(path: &str) -> String {
           if path == "/" {
               "~".to_string()
           } else {
               path.rsplit('/').next().unwrap_or(path).to_string()
           }
       }
       ```

    5. Update the initial history message to use current year dynamically (or just update the hardcoded date).
  </action>
  <verify>
    Run `trunk serve`:
    - Terminal prompt shows "guest@virtualmac ~ %" when at root
    - After `cd /Documents`, prompt shows "guest@virtualmac Documents %"
    - After `cd` (no args), returns to root with "~" in prompt
  </verify>
  <done>Prompt displays macOS-style format with directory name; cd navigates correctly in VirtualFileSystem structure</done>
</task>

</tasks>

<verification>
1. `trunk build` compiles without errors
2. Terminal and Finder show identical file system state
3. Creating/deleting files in Terminal immediately appears in Finder (and vice versa)
4. Prompt format matches "guest@virtualmac [dir] %"
</verification>

<success_criteria>
- Terminal uses VirtualFileSystem (no more FsNode)
- ls, cd, cat, mkdir, rm, touch work with VirtualFileSystem
- File changes sync between Terminal and Finder in real-time
- Prompt shows current directory name in zsh format
</success_criteria>

<output>
After completion, create `.planning/phases/02-terminal-polish/02-01-SUMMARY.md`
</output>
