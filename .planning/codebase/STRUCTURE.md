# Codebase Structure

**Analysis Date:** 2026-01-17

## Directory Layout

```
virtual-mac/
├── src/                    # Rust source code (Leptos components)
│   ├── lib.rs              # WASM entry point, App component, module declarations
│   ├── app_switcher.rs     # Cmd+Tab app switching overlay
│   ├── calculator.rs       # Calculator application component
│   ├── context_menu.rs     # Right-click context menu system
│   ├── desktop.rs          # Desktop background with selection rectangle
│   ├── dock.rs             # macOS-style dock with magnification
│   ├── file_system.rs      # Virtual filesystem with localStorage persistence
│   ├── finder.rs           # File browser application
│   ├── menu_bar.rs         # Menu bar with dropdowns, clock, Control Center
│   ├── modals.rs           # Modal dialogs (About, Shut Down, Force Quit, etc.)
│   ├── spotlight.rs        # Cmd+Space search overlay
│   ├── system_settings.rs  # System Settings application
│   ├── system_state.rs     # Global system state (power, lock, modals)
│   ├── terminal.rs         # Simulated terminal with shell commands
│   ├── textedit.rs         # Rich text editor application
│   ├── theme.rs            # Light/dark theme context
│   ├── wallpaper.rs        # Wallpaper selection context
│   ├── window_manager.rs   # Window state, drag/resize, z-ordering
│   └── styles.css          # Component CSS styles
├── e2e/                    # Playwright E2E tests (TypeScript)
│   ├── page-objects/       # Page object models
│   │   ├── calculator.page.ts
│   │   ├── desktop.page.ts
│   │   ├── dock.page.ts
│   │   ├── finder.page.ts
│   │   ├── index.ts        # Barrel export
│   │   ├── menu-bar.page.ts
│   │   └── window-manager.page.ts
│   └── specs/              # Test specifications
│       ├── calculator.spec.ts
│       ├── desktop.spec.ts
│       ├── dock.spec.ts
│       ├── finder.spec.ts
│       ├── menu-bar.spec.ts
│       └── window-manager.spec.ts
├── dist/                   # Built WASM output (generated by trunk build)
├── target/                 # Cargo build artifacts (generated)
├── node_modules/           # NPM dependencies for E2E tests (generated)
├── .planning/              # GSD planning documents
│   └── codebase/           # Codebase analysis documents
├── .github/                # GitHub workflows/config
├── index.html              # Trunk entry point (HTML shell)
├── styles.css              # Global CSS styles (36KB)
├── Cargo.toml              # Rust dependencies and crate config
├── Cargo.lock              # Locked Rust dependency versions
├── package.json            # NPM config for E2E tests
├── package-lock.json       # Locked NPM dependency versions
├── playwright.config.ts    # Playwright configuration
├── tsconfig.json           # TypeScript config for E2E tests
├── build.rs                # Cargo build script (sets BUILD_TIME env var)
├── state.json              # Sample state file (not actively used)
├── CLAUDE.md               # Claude Code instructions
├── AGENTS.md               # Agent documentation
├── README.md               # Project documentation
└── LICENSE                 # MIT License
```

## Directory Purposes

**`src/`:**
- Purpose: All Rust/Leptos application code
- Contains: One file per component/module, `lib.rs` as entry
- Key files: `lib.rs`, `window_manager.rs`, `file_system.rs`, `system_state.rs`
- Pattern: Flat structure, no nested directories

**`e2e/`:**
- Purpose: End-to-end tests using Playwright
- Contains: TypeScript test files and page objects
- Note: E2E tests under moratorium per CLAUDE.md

**`dist/`:**
- Purpose: Trunk build output (WASM, JS glue, HTML, CSS)
- Generated: Yes (by `trunk build` or `trunk serve`)
- Committed: No (in .gitignore)

**`target/`:**
- Purpose: Cargo compilation artifacts (debug/release builds)
- Generated: Yes
- Committed: No (in .gitignore)

## Key File Locations

**Entry Points:**
- `src/lib.rs`: WASM entry point via `#[wasm_bindgen(start)]`, root App component
- `index.html`: HTML shell for Trunk bundler, references CSS files

**Configuration:**
- `Cargo.toml`: Rust dependencies (leptos, wasm-bindgen, web-sys, serde)
- `package.json`: NPM dependencies (playwright only)
- `playwright.config.ts`: E2E test settings (baseURL, timeout)
- `build.rs`: Sets BUILD_TIME environment variable at compile time

**Core Logic (by size/importance):**
- `src/window_manager.rs` (788 lines): Window state, drag/resize operations, keyboard shortcuts, app content routing
- `src/menu_bar.rs` (517 lines): Menu bar dropdowns, clock updates, Control Center toggles
- `src/file_system.rs` (485 lines): VirtualFileSystem with HashMap storage, CRUD operations, localStorage persistence
- `src/system_settings.rs` (280 lines): Settings panes (General, Appearance, Wallpaper)
- `src/finder.rs` (298 lines): File browser with sidebar, grid view, navigation history
- `src/terminal.rs` (294 lines): Shell simulation with cd, ls, cat, pwd commands
- `src/dock.rs` (259 lines): Dock with icon magnification effect
- `src/context_menu.rs` (231 lines): Context menu state and item definitions
- `src/spotlight.rs` (205 lines): Cmd+Space search with keyboard navigation
- `src/modals.rs` (264 lines): Modal dialogs for system actions
- `src/app_switcher.rs` (161 lines): Cmd+Tab overlay
- `src/calculator.rs` (143 lines): Basic arithmetic calculator
- `src/desktop.rs` (131 lines): Desktop background, selection rectangle
- `src/wallpaper.rs` (109 lines): Wallpaper definitions and context
- `src/theme.rs` (114 lines): Theme context with localStorage
- `src/textedit.rs` (97 lines): Rich text editor
- `src/system_state.rs` (89 lines): SystemState struct with power/lock/modal state
- `src/lib.rs` (70 lines): Module declarations and App composition

**Styling:**
- `styles.css` (root): Global styles, ~36KB
- `src/styles.css`: Additional component styles (linked in index.html)

## Naming Conventions

**Files:**
- Rust source: `snake_case.rs` (e.g., `window_manager.rs`, `system_state.rs`, `file_system.rs`)
- TypeScript tests: `kebab-case.spec.ts` (e.g., `window-manager.spec.ts`)
- Page objects: `kebab-case.page.ts` (e.g., `calculator.page.ts`)

**Rust Modules:**
- One component per file, file name matches module name
- Public components exported via `pub fn`
- Internal helpers remain private

**Components:**
- PascalCase for Leptos components: `WindowManager`, `SystemSettings`, `FileSystemProvider`
- Function names match component names

**Signals:**
- Tuple destructuring pattern: `let (value, set_value) = signal(initial);`
- Read signal: noun (`windows`, `theme`, `current_path`)
- Write signal: `set_` prefix (`set_windows`, `set_theme`, `set_current_path`)

**Types:**
- Structs: PascalCase (`WindowState`, `FileEntry`, `DockItem`)
- Enums: PascalCase with PascalCase variants (`AppType::Calculator`, `PowerState::Sleeping`)
- Type aliases: PascalCase (`WindowId = usize`)

## Where to Add New Code

**New macOS-style Application:**
1. Create `src/new_app.rs` with `#[component] pub fn NewApp() -> impl IntoView { ... }`
2. Add `mod new_app;` in `src/lib.rs`
3. Add `AppType::NewApp` variant to enum in `src/window_manager.rs`
4. Add match arm in WindowManager content rendering (~line 735-748)
5. Optionally add to initial windows list (~line 140-146)
6. Add to dock items in `src/dock.rs` if pinned (apps vec ~line 165-176)

**New Overlay (Spotlight-style):**
1. Create `src/new_overlay.rs` with visibility signal
2. Set up global keyboard listener with `Effect::new` and `Closure::wrap`
3. Add `mod new_overlay;` in `src/lib.rs`
4. Add component to App view after WindowManager

**New System Setting Pane:**
1. Add `SettingsNavItem` in `src/system_settings.rs` settings-nav section
2. Add match arm in settings-content section (~line 91-97)
3. Create `#[component] fn NewPane()` in same file

**New Context/Global State:**
1. Create struct with `RwSignal` fields (see `ThemeContext` pattern in `src/theme.rs`)
2. Create `provide_*` function and `use_*` accessor
3. Wrap in App component hierarchy in `src/lib.rs`
4. Access via `expect_context::<YourContext>()`

**New File System Operation:**
1. Add method to `VirtualFileSystem` impl in `src/file_system.rs`
2. Call `self.bump_version()` and `self.save_to_storage()` for mutations

**New E2E Test (when moratorium lifted):**
1. Create page object in `e2e/page-objects/new-feature.page.ts`
2. Export from `e2e/page-objects/index.ts`
3. Create spec in `e2e/specs/new-feature.spec.ts`

## Special Directories

**`.planning/`:**
- Purpose: GSD planning and codebase documentation
- Generated: No (created by planning tools)
- Committed: Yes

**`.planning/codebase/`:**
- Purpose: Architecture and convention analysis documents
- Files: ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, CONCERNS.md, STACK.md, INTEGRATIONS.md
- Used by: GSD planning and execution commands

**`.claude/`:**
- Purpose: Claude Code settings
- Generated: Yes
- Committed: Partial

**`dist/.stage/`:**
- Purpose: Trunk staging during build
- Generated: Yes
- Committed: No

---

*Structure analysis: 2026-01-17*
